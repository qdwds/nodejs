<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <input type="file" id="file">
</body>

</html>
<script>
  document.getElementById('file').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    //  获取文件名
    const file_name = file.name.split('.')[0]
    let cur = 0;
    let size = 1024 * 1024;
    const fileChunks = [];
    while (cur < file.size) {
      fileChunks.push({
        file: file.slice(cur, cur + size)
      })
      cur += size;
    }
    //  转成请求数组 里面每个都是formData
    const requestList = fileChunks
      .map(({ file }, index) => {
        const formData = new FormData();
        formData.append('chunk', file);
        //  根据名称加下标格式发送  图片-1
        formData.append('file_name', `${file_name}-${index}`)
        return { formData }
      })
      .map(async ({ formData }) => request({
        url: "http://localhost:3000",
        data: formData
      })

      )
      console.log(requestList);
    //  并发发送
    await Promise.all(requestList)
    // console.log(requestList);
    console.log('合并');
    await mergeRequest()
  })

  //  封装请求
  function request({
    url,
    method = "POST",
    data,
    header = {},
    requestList,  //  上传文件列表
  }) {
    return new Promise(resolve => {
      const xhr = new XMLHttpRequest(); //  ajax对象
      //  请求
      xhr.open(method, url)
      //  设置请求头
      Object.keys(header).forEach(key => {
        xhr.setRequestHeader(key, header[key])
      });
      //  发送数据
      xhr.send(data)
      xhr.onload = e => {
        resolve({
          data: e.target.response
        })
      }
    })
  }

  //  上传成功 合并切片
  const mergeRequest = async () => {
    // await request({
    //   url: "http://localhost:4000/merge",
    //   header: {
    //     "content-type": "application/json"
    //   }
    // })
    // alert('ok')
  }
</script>